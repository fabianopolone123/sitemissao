{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios | Missão Andrews</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'shop/styles.css' %}">
    <script src="{% static 'shop/vendor/chart.umd.min.js' %}"></script>
</head>
<body>
    <header class="manage-header">
        <h1>Relatórios de Vendas</h1>
        <div class="manage-header-actions">
            <a class="secondary-button link-button" href="{% url 'manage_products_page' %}">Voltar ao painel</a>
            <a class="secondary-button link-button" href="{% url 'manage_sales_page' %}">Vender</a>
        </div>
    </header>

    <main class="manage-page">
        <section class="section-card report-summary-grid">
            <article class="report-card">
                <div class="cart-meta">Total de pedidos</div>
                <strong>{{ total_orders }}</strong>
            </article>
            <article class="report-card">
                <div class="cart-meta">Pedidos pagos</div>
                <strong>{{ total_paid_orders }}</strong>
            </article>
            <article class="report-card">
                <div class="cart-meta">Faturamento</div>
                <strong>R$ {{ total_revenue|floatformat:2 }}</strong>
            </article>
            <article class="report-card">
                <div class="cart-meta">Ticket médio</div>
                <strong>R$ {{ average_ticket|floatformat:2 }}</strong>
            </article>
        </section>

        <section class="section-card report-charts-grid">
            <article class="report-card">
                <p class="panel-subtitle">Faturamento diário (pagos)</p>
                <canvas id="chart-daily-revenue"></canvas>
            </article>
            <article class="report-card">
                <p class="panel-subtitle">Pedidos por forma de pagamento</p>
                <canvas id="chart-payment-methods"></canvas>
            </article>
            <article class="report-card">
                <p class="panel-subtitle">Valor por forma de pagamento</p>
                <canvas id="chart-payment-totals"></canvas>
            </article>
            <article class="report-card">
                <p class="panel-subtitle">Status dos pedidos</p>
                <canvas id="chart-status"></canvas>
            </article>
        </section>

        <section class="section-card" style="margin-top: 14px;">
            <p class="panel-subtitle">Relação de pedidos entregues</p>
            <div class="panel-list">
                {% for order in delivered_orders %}
                    <article class="panel-row {% if order.is_paid %}panel-row-active{% else %}panel-row-inactive{% endif %}">
                        <div>
                            <strong>Pedido #{{ order.id }}</strong>
                            <div class="cart-meta">Cliente: {{ order.first_name }} {{ order.last_name }}</div>
                            <div class="cart-meta">Telefone: {{ order.whatsapp }}</div>
                            <div class="cart-meta">Pagamento: {{ order.get_payment_method_display }}</div>
                            <div class="cart-meta">Total: R$ {{ order.total }}</div>
                            <div class="cart-meta">Entrega: {% if order.delivered_at %}{{ order.delivered_at|date:"d/m/Y H:i" }}{% else %}-{% endif %}</div>
                            <div class="cart-meta">
                                Status pagamento:
                                {% if order.is_paid %}
                                    <span class="status-chip status-chip-active">Pago</span>
                                {% else %}
                                    <span class="status-chip status-chip-inactive">Não pago</span>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                {% empty %}
                    <p>Nenhum pedido entregue.</p>
                {% endfor %}
            </div>
        </section>

        <section class="section-card" style="margin-top: 14px;">
            <p class="panel-subtitle">Atenção: entregues e não pagos</p>
            <div class="panel-list panel-list-inactive">
                {% for order in delivered_unpaid_orders %}
                    <article class="panel-row panel-row-inactive">
                        <div>
                            <strong>Pedido #{{ order.id }}</strong>
                            <div class="cart-meta">Cliente: {{ order.first_name }} {{ order.last_name }}</div>
                            <div class="cart-meta">Telefone: {{ order.whatsapp }}</div>
                            <div class="cart-meta">Pagamento: {{ order.get_payment_method_display }}</div>
                            <div class="cart-meta">Total: R$ {{ order.total }}</div>
                            <div class="cart-meta">Entrega: {% if order.delivered_at %}{{ order.delivered_at|date:"d/m/Y H:i" }}{% else %}-{% endif %}</div>
                        </div>
                    </article>
                {% empty %}
                    <p>Ótimo: não há pedidos entregues sem pagamento.</p>
                {% endfor %}
            </div>
        </section>
    </main>

    {{ chart_daily_labels|json_script:"chart-daily-labels" }}
    {{ chart_daily_values|json_script:"chart-daily-values" }}
    {{ chart_daily_counts|json_script:"chart-daily-counts" }}
    {{ chart_payment_labels|json_script:"chart-payment-labels" }}
    {{ chart_payment_counts|json_script:"chart-payment-counts" }}
    {{ chart_payment_totals|json_script:"chart-payment-totals" }}
    {{ status_counter|json_script:"chart-status-counter" }}

    <script src="{% static 'shop/manage_reports.js' %}"></script>
</body>
</html>
