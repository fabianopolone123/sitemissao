{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Produtos | Missão Andrews</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'shop/styles.css' %}">
</head>
<body
    data-print-order-id="{% if print_order_id %}{{ print_order_id }}{% endif %}"
    data-print-order-template="{{ print_order_template_url }}"
>
    <header class="manage-header">
        <h1>Painel de Produtos</h1>
        <div class="manage-header-actions">
            <a class="secondary-button link-button" href="{% url 'home' %}">Voltar para loja</a>
        </div>
    </header>

    <main class="manage-page">
        <nav class="manage-nav">
            <button type="button" class="secondary-button manage-tab-btn is-active" data-target="secao-produtos">Produtos</button>
            <button type="button" class="secondary-button manage-tab-btn" data-target="secao-pedidos">Pedidos</button>
            <button type="button" class="secondary-button manage-tab-btn" data-target="secao-custos">Custos</button>
            <button type="button" class="secondary-button manage-tab-btn" data-target="secao-whatsapp">WhatsApp</button>
            <button type="button" class="secondary-button manage-tab-btn" data-target="secao-usuarios">Usuários</button>
            <a class="secondary-button link-button" href="{% url 'manage_sales_page' %}">Vender</a>
            <a class="secondary-button link-button" href="{% url 'manage_reports_page' %}">Relatórios</a>
            <a class="secondary-button link-button" href="{% url 'manage_audit_page' %}">Auditoria</a>
        </nav>

        {% if messages %}
            <section class="flash-list">
                {% for message in messages %}
                    <p class="flash-item">{{ message }}</p>
                {% endfor %}
            </section>
        {% endif %}

        <section id="secao-produtos" class="panel-grid section-card manage-section is-visible">
            <div>
                <p class="panel-subtitle">Produtos ativos ({{ active_products|length }})</p>
                <div class="panel-list">
                    {% for product in active_products %}
                        <article class="panel-row panel-row-active">
                            <img src="{{ product.image_source }}" alt="{{ product.name }}">
                            <div>
                                <strong>{{ product.name }}</strong>
                                <div class="cart-meta">R$ {{ product.price }} <span class="status-chip status-chip-active">Ativo</span></div>
                                {% if product.variants.all %}
                                    <div class="cart-meta">Variações:
                                        {% for variant in product.variants.all %}
                                            {{ variant.name }} (R$ {{ variant.price }}){% if not forloop.last %}, {% endif %}
                                        {% empty %}
                                            sem variações
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="panel-row-actions">
                                    <a class="secondary-button link-button" href="{% url 'manage_products_page' %}?edit={{ product.id }}">Editar</a>
                                    <form method="post" action="{% url 'manage_products_delete_page' product.id %}" onsubmit="return confirm('Deseja remover este produto?');">
                                        {% csrf_token %}
                                        <button type="submit" class="danger-btn">Remover</button>
                                    </form>
                                </div>
                            </div>
                        </article>
                    {% empty %}
                        <p>Nenhum produto ativo.</p>
                    {% endfor %}
                </div>

                <p class="panel-subtitle panel-subtitle-muted">Produtos inativos ({{ inactive_products|length }})</p>
                <div class="panel-list panel-list-inactive">
                    {% for product in inactive_products %}
                        <article class="panel-row panel-row-inactive">
                            <img src="{{ product.image_source }}" alt="{{ product.name }}">
                            <div>
                                <strong>{{ product.name }}</strong>
                                <div class="cart-meta">R$ {{ product.price }} <span class="status-chip status-chip-inactive">Inativo</span></div>
                                <div class="cart-meta">Variações:
                                    {% for variant in product.variants.all %}
                                        {{ variant.name }} (R$ {{ variant.price }}){% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        sem variações
                                    {% endfor %}
                                </div>
                                <div class="panel-row-actions">
                                    <a class="secondary-button link-button" href="{% url 'manage_products_page' %}?edit={{ product.id }}">Editar</a>
                                    <form method="post" action="{% url 'manage_products_delete_page' product.id %}" onsubmit="return confirm('Deseja remover este produto?');">
                                        {% csrf_token %}
                                        <button type="submit" class="danger-btn">Remover</button>
                                    </form>
                                </div>
                            </div>
                        </article>
                    {% empty %}
                        <p>Nenhum produto inativo.</p>
                    {% endfor %}
                </div>
            </div>

            <div>
                <p class="panel-subtitle">{% if editing_product %}Editar produto{% else %}Criar produto{% endif %}</p>
                <form class="checkout-form" method="post" action="{% url 'manage_products_save_page' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{% if editing_product %}{{ editing_product.id }}{% endif %}">
                    <input type="text" name="name" placeholder="Nome do produto" value="{% if editing_product %}{{ editing_product.name }}{% endif %}" required>
                    <input type="text" name="cause" placeholder="Categoria/causa" value="{% if editing_product %}{{ editing_product.cause }}{% endif %}" required>
                    <input type="text" name="price" placeholder="Preço (ex: 12.00)" value="{% if editing_product %}{{ editing_product.price }}{% endif %}" required>
                    <textarea name="description" rows="3" placeholder="Descrição">{% if editing_product %}{{ editing_product.description }}{% endif %}</textarea>
                    <input type="url" name="image_url" placeholder="URL da foto (opcional)" value="{% if editing_product %}{{ editing_product.image_url }}{% endif %}">
                    <input type="file" name="image_file" accept="image/*">
                    <textarea name="variants_text" rows="4" placeholder="Variações (uma por linha):&#10;Com suco|15.00&#10;Com guaraná|15.00">{{ editing_variants_text }}</textarea>
                    <label class="checkbox-line">
                        <input type="checkbox" name="active" {% if not editing_product or editing_product.active %}checked{% endif %}>
                        Produto ativo
                    </label>
                    <button class="add-btn" type="submit">Salvar produto</button>
                    <a class="secondary-button link-button" href="{% url 'manage_products_page' %}">Novo produto</a>
                </form>
            </div>
        </section>

        <section id="secao-pedidos" class="orders-section section-card manage-section">
            <h2>Pedidos recebidos</h2>
            <form method="post" action="{% url 'manage_orders_mark_all_paid_page' %}" onsubmit="return confirm('Marcar todos os pedidos não pagos como pagos?');" style="margin-bottom: 10px;">
                {% csrf_token %}
                <button type="submit" class="add-btn">Marcar todos como pagos</button>
            </form>
            <input
                id="orders-search"
                type="search"
                class="orders-search-input"
                placeholder="Pesquisar pedido por cliente, telefone, número ou item..."
            >
            <div class="orders-list">
                {% for order in orders %}
                    <article class="order-card {% if order.is_paid %}order-card-paid{% else %}order-card-unpaid{% endif %}" data-order-search="#{{ order.id }} {{ order.first_name }} {{ order.last_name }} {{ order.whatsapp }} {{ order.items_json|safe }}">
                        <div class="order-head">
                            <strong>Pedido #{{ order.id }}</strong>
                            <div>
                                <span class="status-chip {% if order.is_paid %}status-chip-active{% else %}status-chip-inactive{% endif %}">
                                    {% if order.is_paid %}Pago{% else %}Não pago{% endif %}
                                </span>
                                <span class="status-chip {% if order.is_delivered %}status-chip-active{% else %}status-chip-inactive{% endif %}">
                                    {% if order.is_delivered %}Entregue{% else %}Não entregue{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="order-meta">
                            <div><strong>Cliente:</strong> {{ order.first_name }} {{ order.last_name }}</div>
                            <div><strong>Telefone:</strong> {{ order.whatsapp }}</div>
                            <div><strong>Pagamento:</strong> {{ order.get_payment_method_display }}</div>
                            <div><strong>Total:</strong> R$ {{ order.total }}</div>
                            <div><strong>Data:</strong> {{ order.created_at|date:"d/m/Y H:i" }}</div>
                            <div><strong>Entrega:</strong> {% if order.delivered_at %}{{ order.delivered_at|date:"d/m/Y H:i" }}{% else %}Pendente{% endif %}</div>
                        </div>
                        <div class="order-items">
                            <strong>Itens:</strong>
                            <ul>
                                {% for item in order.items_json %}
                                    <li>{{ item.quantity }}x {{ item.name }} (R$ {{ item.price }}) - subtotal R$ {{ item.subtotal }}</li>
                                {% empty %}
                                    <li>Sem itens registrados.</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <form method="post" action="{% url 'manage_order_delivery_page' order.id %}" class="order-actions">
                            {% csrf_token %}
                            {% if order.is_delivered %}
                                <button type="submit" name="action" value="mark_undelivered" class="secondary-button">Marcar como não entregue</button>
                            {% else %}
                                <button type="submit" name="action" value="mark_delivered" class="add-btn">Marcar como entregue</button>
                            {% endif %}
                        </form>
                        <form method="post" action="{% url 'manage_order_delete_page' order.id %}" class="order-actions order-delete-form">
                            {% csrf_token %}
                            <input type="hidden" name="delete_password">
                            <button type="submit" class="danger-btn">Excluir pedido</button>
                        </form>
                    </article>
                {% empty %}
                    <p>Nenhum pedido encontrado.</p>
                {% endfor %}
            </div>
        </section>

        <section id="secao-custos" class="orders-section section-card manage-section">
            <h2>Cadastro de custos</h2>
            <p class="cart-meta">Total de custos cadastrados: <strong>R$ {{ total_costs|floatformat:2 }}</strong></p>

            <form class="checkout-form user-create-form" method="post" action="{% url 'manage_costs_create_page' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="text" name="name" placeholder="Nome do custo" required>
                <input type="text" name="amount" placeholder="Valor (ex: 25.90)" required>
                <input type="file" name="receipt_file" accept="image/*">
                <button class="add-btn" type="submit">Cadastrar custo</button>
            </form>

            <div class="panel-list">
                {% for cost in costs %}
                    <article class="panel-row panel-row-full">
                        <div>
                            <strong>{{ cost.name }}</strong>
                            <div class="cart-meta">Valor: R$ {{ cost.amount|floatformat:2 }}</div>
                            <div class="cart-meta">Data: {{ cost.created_at|date:"d/m/Y H:i" }}</div>
                            {% if cost.receipt_file %}
                                <div class="cart-meta">
                                    <a class="secondary-button link-button" href="{{ cost.receipt_file.url }}" target="_blank">Ver comprovante</a>
                                </div>
                            {% endif %}
                            <form method="post" action="{% url 'manage_costs_delete_page' cost.id %}" onsubmit="return confirm('Deseja remover este custo?');" style="margin-top: 6px;">
                                {% csrf_token %}
                                <button type="submit" class="danger-btn">Remover</button>
                            </form>
                        </div>
                    </article>
                {% empty %}
                    <p>Nenhum custo cadastrado.</p>
                {% endfor %}
            </div>
        </section>

        <section id="secao-whatsapp" class="orders-section section-card manage-section">
            <h2>Notificações WhatsApp</h2>
            <p class="cart-meta">Cadastre os números que devem receber aviso quando o pagamento for aprovado.</p>

            <form class="checkout-form user-create-form" method="post" action="{% url 'manage_whatsapp_recipient_create_page' %}">
                {% csrf_token %}
                <input type="text" name="name" placeholder="Nome" required>
                <input type="text" name="phone" placeholder="WhatsApp (ex: 14988208154 ou 5514988208154)" required>
                <button class="add-btn" type="submit">Cadastrar contato</button>
            </form>

            <div class="users-list">
                {% for recipient in whatsapp_recipients %}
                    <article class="user-card">
                        <div class="order-head">
                            <strong>{{ recipient.name }}</strong>
                            <span class="status-chip {% if recipient.active %}status-chip-active{% else %}status-chip-inactive{% endif %}">
                                {% if recipient.active %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </div>
                        <div class="order-meta">
                            <div><strong>WhatsApp:</strong> {{ recipient.phone }}</div>
                        </div>
                        <form method="post" action="{% url 'manage_whatsapp_recipient_delete_page' recipient.id %}" onsubmit="return confirm('Deseja remover este contato?');">
                            {% csrf_token %}
                            <button type="submit" class="danger-btn">Remover</button>
                        </form>
                    </article>
                {% empty %}
                    <p>Nenhum contato cadastrado.</p>
                {% endfor %}
            </div>
        </section>

        <section id="secao-usuarios" class="orders-section section-card manage-section">
            <h2>Usuários de acesso</h2>
            <p class="cart-meta">Cadastre aqui novos logins para acessar este painel.</p>

            <form class="checkout-form user-create-form" method="post" action="{% url 'manage_users_create_page' %}">
                {% csrf_token %}
                <input type="text" name="username" placeholder="Usuário" required>
                <input type="password" name="password" placeholder="Senha" required>
                <input type="password" name="password_confirm" placeholder="Confirmar senha" required>
                <label class="checkbox-line">
                    <input type="checkbox" name="is_staff">
                    Marcar também como membro da equipe (staff)
                </label>
                <button class="add-btn" type="submit">Criar login</button>
            </form>

            <div class="users-list">
                {% for user_item in users %}
                    <article class="user-card">
                        <div class="order-head">
                            <strong>{{ user_item.username }}</strong>
                            {% if user_item.is_staff %}
                                <span class="status-chip status-chip-active">Staff</span>
                            {% else %}
                                <span class="status-chip status-chip-inactive">Comum</span>
                            {% endif %}
                        </div>
                        <div class="order-meta">
                            <div><strong>Status:</strong> {% if user_item.is_active %}Ativo{% else %}Inativo{% endif %}</div>
                            <div><strong>Último login:</strong> {% if user_item.last_login %}{{ user_item.last_login|date:"d/m/Y H:i" }}{% else %}Nunca{% endif %}</div>
                        </div>
                    </article>
                {% empty %}
                    <p>Nenhum usuário encontrado.</p>
                {% endfor %}
            </div>
        </section>
    </main>
    <script>
        (function () {
            const sections = document.querySelectorAll('.manage-section');
            const tabButtons = document.querySelectorAll('.manage-tab-btn');
            const ordersSearch = document.getElementById('orders-search');
            const orderCards = document.querySelectorAll('.order-card');

            function showSection(targetId) {
                sections.forEach((section) => {
                    section.classList.toggle('is-visible', section.id === targetId);
                });
                tabButtons.forEach((button) => {
                    button.classList.toggle('is-active', button.dataset.target === targetId);
                });
            }

            tabButtons.forEach((button) => {
                button.addEventListener('click', () => showSection(button.dataset.target));
            });

            if (ordersSearch) {
                ordersSearch.addEventListener('input', () => {
                    const term = ordersSearch.value.trim().toLowerCase();
                    orderCards.forEach((card) => {
                        const haystack = (card.getAttribute('data-order-search') || '').toLowerCase();
                        const matches = !term || haystack.includes(term);
                        card.style.display = matches ? '' : 'none';
                    });
                });
            }

            document.querySelectorAll('.order-delete-form').forEach((form) => {
                form.addEventListener('submit', (event) => {
                    const password = window.prompt('Digite a senha para excluir o pedido:');
                    if (!password) {
                        event.preventDefault();
                        return;
                    }
                    const input = form.querySelector('input[name="delete_password"]');
                    input.value = password;
                });
            });

            const printOrderId = document.body.dataset.printOrderId;
            const printOrderTemplate = document.body.dataset.printOrderTemplate;
            if (printOrderId && printOrderTemplate) {
                const printUrl = printOrderTemplate.replace('/0/', `/${printOrderId}/`);
                window.setTimeout(() => {
                    window.open(printUrl, '_blank', 'noopener,noreferrer');
                }, 250);
            }
        })();
    </script>
</body>
</html>
